// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Model pentru companii (clienți)
model Company {
  id            String         @id @default(uuid())
  cui           String         @unique // Cod Unic de Înregistrare
  name          String
  address       String?
  city          String?
  county        String?
  postalCode    String?
  country       String         @default("România")
  email         String?
  phone         String?
  regCom        String?        // Număr Registrul Comerțului
  iban          String?
  bank          String?
  legalRep      String?        // Reprezentant legal
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  conversations Conversation[]
  invoices      Invoice[]
  proformas     Proforma[]
  offers        Offer[]
  
  @@index([cui])
}

// Model pentru utilizatori
model User {
  id                String         @id @default(uuid())
  email             String         @unique
  name              String
  password          String         // Hash bcrypt
  role              String         @default("user") // user, admin

  // Email verification
  emailVerified     Boolean        @default(false)
  verificationToken String?        @unique

  // Password reset
  resetToken        String?        @unique
  resetTokenExpiry  DateTime?

  // Profile
  phone                String?
  phoneVerified        Boolean        @default(false)
  phoneVerificationCode String?
  phoneVerificationExpiry DateTime?
  company              String?
  cui                  String?
  avatar               String?

  // Status
  isActive          Boolean        @default(true)
  lastLogin         DateTime?

  // Stripe relationship
  stripeCustomer       StripeCustomer?

  // Subscription cache (denormalized for quick checks)
  subscriptionStatus   String      @default("inactive") // active, past_due, inactive, canceled
  subscriptionTier     String      @default("free")     // free, monthly, annual
  subscriptionExpiresAt DateTime?

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  conversations     Conversation[]
  messages          Message[]
  anafAuth          AnafAuth?

  @@index([email])
  @@index([verificationToken])
  @@index([resetToken])
}

// Model pentru autentificare ANAF e-Factura
model AnafAuth {
  id            String    @id @default(uuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // OAuth2 Tokens
  accessToken   String    @db.Text
  refreshToken  String    @db.Text
  tokenType     String    @default("Bearer")
  expiresAt     DateTime
  
  // ANAF User Info
  cui           String?   // CUI-ul companiei asociate contului ANAF
  companyName   String?
  
  // Status
  isActive      Boolean   @default(true)
  lastRefresh   DateTime  @default(now())
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([userId])
  @@index([cui])
}

// Model pentru setări companie emitentă (per utilizator)
model CompanySettings {
  id        String   @id @default(uuid())
  userId    String   @unique
  
  // Date companie
  cui       String?
  name      String?
  regCom    String?
  address   String?
  city      String?
  county    String?
  postalCode String?
  country   String?  @default("România")
  
  // Contact
  phone     String?
  email     String?
  
  // Bancar
  bank      String?
  iban      String?
  capital   String?
  
  // Reprezentant legal
  legalRep  String?
  
  // TVA Settings
  isVatPayer    Boolean  @default(true)   // Plătitor de TVA
  vatRate       Float    @default(19)     // Cota TVA (%)
  
  // Template-uri preferate pentru documente
  invoiceTemplate  String? @default("modern")   // Template facturi
  proformaTemplate String? @default("modern")   // Template proforma
  quoteTemplate    String? @default("modern")   // Template oferte
  
  // Seriile și numerotare documente
  invoiceSeries     String? @default("FAC")  // Serie facturi
  invoiceStartNumber Int?   @default(1)      // Număr început facturi
  proformaSeries    String? @default("PRO")  // Serie proforma
  proformaStartNumber Int?  @default(1)      // Număr început proforma
  quoteSeries       String? @default("OFF")  // Serie oferte
  quoteStartNumber  Int?    @default(1)      // Număr început oferte
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

// Model pentru conversații
model Conversation {
  id            String         @id @default(uuid())
  title         String
  companyId     String?
  company       Company?       @relation(fields: [companyId], references: [id])
  userId        String?
  user          User?          @relation(fields: [userId], references: [id])
  status        String         @default("active") // active, archived
  type          String         @default("web") // web, whatsapp
  phoneNumber   String?        // Pentru WhatsApp
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  messages      Message[]
  invoices      Invoice[]
  proformas     Proforma[]
  offers        Offer[]

  @@index([companyId])
  @@index([userId])
  @@index([phoneNumber])
  @@index([type])
}

// Model pentru mesaje
model Message {
  id                String       @id @default(uuid())
  conversationId    String
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId            String?
  user              User?        @relation(fields: [userId], references: [id])
  text              String       @db.Text
  sender            String       // 'user', 'system', 'ai', 'assistant'
  whatsappMessageId String?      // ID mesaj WhatsApp pentru tracking
  timestamp         DateTime     @default(now())

  @@index([conversationId])
  @@index([userId])
  @@index([whatsappMessageId])
}

// Model pentru facturi
model Invoice {
  id                String       @id @default(uuid())
  invoiceNumber     String       @unique
  conversationId    String?
  conversation      Conversation? @relation(fields: [conversationId], references: [id])
  companyId         String?
  company           Company?      @relation(fields: [companyId], references: [id])
  
  // Calcule financiare
  subtotal          Float
  tvaAmount         Float
  total             Float
  
  // Informații factură
  issueDate         DateTime     @default(now())
  dueDate           DateTime?
  status            String       @default("generated") // generated, sent, paid, cancelled
  
  // Informații furnizor/emitent (snapshot la momentul facturării)
  providerName      String
  providerCUI       String
  providerRegCom    String?
  providerAddress   String
  providerCity      String?
  providerCounty    String?
  providerEmail     String?
  providerPhone     String?
  providerBank      String?
  providerIban      String?
  providerCapital   String?
  
  // Informații client/beneficiar (snapshot)
  clientType        String       // 'company' sau 'individual'
  clientName        String
  clientCUI         String?
  clientRegCom      String?
  clientCNP         String?      // pentru persoane fizice
  clientFirstName   String?      // pentru persoane fizice
  clientLastName    String?      // pentru persoane fizice
  clientAddress     String?
  clientCity        String?
  clientCounty      String?
  clientEmail       String?
  
  // Relație cu produse/servicii
  items             InvoiceItem[]
  
  // Relație cu e-Factura ANAF
  eFacturaLogs      EFacturaLog[]
  
  // Metadata
  pdfPath           String?
  template          String        @default("modern") // modern, classic, minimal, elegant
  notes             String?       @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([companyId])
  @@index([conversationId])
  @@index([invoiceNumber])
}

// Model pentru produse/servicii pe factură
model InvoiceItem {
  id                String       @id @default(uuid())
  invoiceId         String
  invoice           Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  name              String       // Denumire produs/serviciu
  description       String?      @db.Text
  unit              String       @default("buc") // unitate de măsură (buc, kg, ora, etc.)
  quantity          Float
  price             Float        // Preț unitar
  vatRate           Float        @default(0.19) // Cota TVA (0.19 = 19%)
  
  // Calcule (stocate pentru istoric)
  subtotal          Float        // quantity * price
  vatAmount         Float        // subtotal * vatRate
  total             Float        // subtotal + vatAmount
  
  createdAt         DateTime     @default(now())
  
  @@index([invoiceId])
}

// Model pentru catalog produse/servicii (pentru recomandări)
model Product {
  id                String       @id @default(uuid())
  name              String       // Denumire produs/serviciu
  description       String?      @db.Text
  category          String?      // Categorie (software, consultanță, etc.)
  unit              String       @default("buc")
  defaultPrice      Float        // Preț implicit
  vatRate           Float        @default(0.19)
  
  // Statistici utilizare
  timesUsed         Int          @default(0)
  lastUsedAt        DateTime?
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  @@index([name])
  @@index([category])
}

// Model pentru sesiuni de chat AI (pentru generare facturi conversațional)
model ChatSession {
  id                String       @id @default(uuid())
  source            String       @default("web") // web, whatsapp
  phoneNumber       String?      // Pentru WhatsApp

  // Stare conversație
  status            String       @default("active") // active, completed, cancelled
  currentStep       String       @default("greeting") // greeting, client_type, client_info, products, confirm, done

  // Context acumulat
  clientType        String?      // company, individual
  clientCUI         String?
  clientName        String?
  clientData        String?      @db.Text // JSON cu toate datele clientului
  productsData      String?      @db.Text // JSON cu produse selectate

  // Referință factură generată
  generatedInvoiceId String?     @unique

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  chatMessages      ChatMessage[]

  @@index([phoneNumber])
  @@index([status])
}

// Model pentru clienți Stripe (utilizatori ChatBill cu abonament)
model StripeCustomer {
  id                String    @id @default(uuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripeCustomerId  String    @unique  // cus_...
  email             String

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  subscriptions     Subscription[]
  paymentInvoices   PaymentInvoice[]

  @@index([stripeCustomerId])
}

// Model pentru abonamente utilizatori
model Subscription {
  id                   String         @id @default(uuid())
  customerId           String
  customer             StripeCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  stripeSubscriptionId String         @unique  // sub_...
  stripePriceId        String         // price_...
  stripeProductId      String         // prod_...

  planName             String         // 'monthly', 'annual'
  planPrice            Float          // In cents (499 for €4.99)
  currency             String         @default("EUR")

  status               String         // active, past_due, canceled, incomplete
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  canceledAt           DateTime?
  cancelAtPeriodEnd    Boolean        @default(false)

  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  @@index([customerId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

// Model pentru facturi de plată Stripe (diferite de Invoice pentru facturare clienți)
model PaymentInvoice {
  id                String         @id @default(uuid())
  customerId        String
  customer          StripeCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  stripeInvoiceId   String         @unique  // in_...
  amount            Float          // In cents
  currency          String         @default("EUR")
  status            String         // paid, open, void, uncollectible
  paidAt            DateTime?

  periodStart       DateTime
  periodEnd         DateTime

  invoiceUrl        String?
  pdfUrl            String?

  createdAt         DateTime       @default(now())

  @@index([customerId])
  @@index([stripeInvoiceId])
}

// Model pentru evenimente webhook Stripe (idempotency + debugging)
model WebhookEvent {
  id                String    @id @default(uuid())

  stripeEventId     String    @unique  // evt_...
  eventType         String    // customer.subscription.created, etc
  eventData         String    @db.Text // Full JSON payload

  processed         Boolean   @default(false)
  processedAt       DateTime?
  error             String?   @db.Text

  createdAt         DateTime  @default(now())

  @@index([stripeEventId])
  @@index([eventType])
  @@index([processed])
}

// Model pentru mesaje chat AI (AI facturare + GPT conversațional)
model ChatMessage {
  id                String       @id @default(uuid())
  sessionId         String?      // Nullable pentru GPT chat general
  session           ChatSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId            String?      // Pentru GPT chat general
  
  role              String       // 'user', 'assistant', 'system'
  content           String       @db.Text
  metadata          String?      @db.Text // JSON pentru date suplimentare (tokens, model, etc.)
  
  createdAt         DateTime     @default(now())
  
  @@index([sessionId])
  @@index([userId])
}

// Model pentru configurare aplicație ANAF e-Factura
model AnafAppConfig {
  id            String    @id @default(uuid())
  
  // Credențiale aplicație înregistrată la ANAF
  clientId      String    @unique
  clientSecret  String    @db.Text
  redirectUri   String
  
  // URLs ANAF (prod/test)
  authUrl       String    @default("https://logincert.anaf.ro/anaf/oauth2/v1/authorize")
  tokenUrl      String    @default("https://logincert.anaf.ro/anaf/oauth2/v1/token")
  apiBaseUrl    String    @default("https://api.anaf.ro/prod/FCTEH/public-v1")
  
  // Setări
  environment   String    @default("test") // test, production
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Model pentru log-uri trimitere facturi ANAF
model EFacturaLog {
  id            String    @id @default(uuid())
  invoiceId     String
  invoice       Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  // Detalii trimitere
  status        String    // pending, success, error
  anafMessageId String?   // ID-ul mesajului din ANAF
  xmlContent    String?   @db.Text // XML-ul generat
  
  // Răspuns ANAF
  responseCode  String?
  responseMsg   String?   @db.Text
  errorDetails  String?   @db.Text
  
  sentAt        DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([invoiceId])
  @@index([status])
}

// Model pentru proforme
model Proforma {
  id                String         @id @default(uuid())
  proformaNumber    String         @unique
  conversationId    String?
  conversation      Conversation?  @relation(fields: [conversationId], references: [id])
  companyId         String?
  company           Company?       @relation(fields: [companyId], references: [id])
  
  // Calcule financiare
  subtotal          Float
  tvaAmount         Float
  total             Float
  
  // Informații proformă
  issueDate         DateTime       @default(now())
  validUntil        DateTime?
  status            String         @default("draft") // draft, sent, accepted, rejected, converted
  
  // Informații furnizor/emitent (snapshot la momentul generării)
  providerName      String
  providerCUI       String
  providerRegCom    String?
  providerAddress   String
  providerCity      String?
  providerCounty    String?
  providerEmail     String?
  providerPhone     String?
  providerBank      String?
  providerIban      String?
  providerCapital   String?
  
  // Informații client/beneficiar (snapshot)
  clientType        String         // 'company' sau 'individual'
  clientName        String
  clientCUI         String?
  clientRegCom      String?
  clientCNP         String?        // pentru persoane fizice
  clientFirstName   String?        // pentru persoane fizice
  clientLastName    String?        // pentru persoane fizice
  clientAddress     String?
  clientCity        String?
  clientCounty      String?
  clientEmail       String?
  
  // Relație cu produse/servicii
  items             ProformaItem[]
  
  // Metadata
  pdfPath           String?
  template          String         @default("modern") // modern, classic, minimal, elegant
  notes             String?        @db.Text
  convertedToInvoiceId String?     @unique
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  @@index([companyId])
  @@index([conversationId])
  @@index([proformaNumber])
}

// Model pentru produse/servicii pe proformă
model ProformaItem {
  id                String       @id @default(uuid())
  proformaId        String
  proforma          Proforma     @relation(fields: [proformaId], references: [id], onDelete: Cascade)
  
  name              String       // Denumire produs/serviciu
  description       String?      @db.Text
  unit              String       @default("buc") // unitate de măsură (buc, kg, ora, etc.)
  quantity          Float
  price             Float        // Preț unitar
  vatRate           Float        @default(0.19) // Cota TVA (0.19 = 19%)
  
  // Calcule (stocate pentru istoric)
  subtotal          Float        // quantity * price
  vatAmount         Float        // subtotal * vatRate
  total             Float        // subtotal + vatAmount
  
  createdAt         DateTime     @default(now())
  
  @@index([proformaId])
}

// Model pentru Oferte de Preț
model Offer {
  id                String         @id @default(uuid())
  offerNumber       String         @unique
  conversationId    String?
  conversation      Conversation?  @relation(fields: [conversationId], references: [id])
  companyId         String?
  company           Company?       @relation(fields: [companyId], references: [id])
  
  // Detalii ofertă
  title             String         // Titlu ofertă
  validity          Int            @default(30) // Valabilitate în zile
  paymentTerms      String         @default("30days") // Termeni de plată
  delivery          String?        // Termen livrare
  
  // Calcule financiare
  subtotal          Float
  tvaAmount         Float
  total             Float
  
  // Informații ofertă
  issueDate         DateTime       @default(now())
  validUntil        DateTime       // Calculat din issueDate + validity
  status            String         @default("draft") // draft, sent, accepted, rejected, expired
  
  // Informații furnizor/emitent (snapshot)
  providerName      String
  providerCUI       String
  providerRegCom    String?
  providerAddress   String
  providerCity      String?
  providerCounty    String?
  providerEmail     String?
  providerPhone     String?
  providerBank      String?
  providerIban      String?
  
  // Informații client/beneficiar (snapshot)
  clientType        String         // 'company' sau 'individual'
  clientName        String
  clientCUI         String?
  clientRegCom      String?
  clientFirstName   String?        // pentru persoane fizice
  clientLastName    String?        // pentru persoane fizice
  clientAddress     String?
  clientCity        String?
  clientCounty      String?
  clientEmail       String?
  clientPhone       String?
  
  // Relație cu produse/servicii
  items             OfferItem[]
  
  // Metadata
  pdfPath           String?
  template          String         @default("modern") // modern, classic, minimal, elegant
  notes             String?        @db.Text
  convertedToInvoiceId String?     @unique
  convertedToProformaId String?    @unique
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  @@index([companyId])
  @@index([conversationId])
  @@index([offerNumber])
}

// Model pentru produse/servicii pe ofertă
model OfferItem {
  id                String       @id @default(uuid())
  offerId           String
  offer             Offer        @relation(fields: [offerId], references: [id], onDelete: Cascade)
  
  name              String       // Denumire produs/serviciu
  description       String?      @db.Text
  unit              String       @default("buc") // unitate de măsură
  quantity          Float
  price             Float        // Preț unitar
  vatRate           Float        @default(0.21) // Cota TVA (0.21 = 21%)
  
  // Calcule (stocate pentru istoric)
  subtotal          Float        // quantity * price
  vatAmount         Float        // subtotal * vatRate
  total             Float        // subtotal + vatAmount
  
  createdAt         DateTime     @default(now())
  
  @@index([offerId])
}


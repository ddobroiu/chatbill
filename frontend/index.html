<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBill - Facturare InteligentƒÉ</title>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #f8f9fa;
            --foreground: #212529;
            --card-background: #ffffff;
            --primary: #0052cc;
            --primary-foreground: #ffffff;
            --secondary: #e9ecef;
            --secondary-foreground: #495057;
            --border: #dee2e6;
            --input: #ced4da;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --font-sans: 'Inter', sans-serif;
            --radius: 0.5rem;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--background);
            color: var(--foreground);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: var(--card-background);
            border-right: 1px solid var(--border);
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0 0.5rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .sidebar-nav {
            flex-grow: 1;
            margin-top: 1.5rem;
        }
        
        .sidebar-footer {
            border-top: 1px solid var(--border);
            padding-top: 1rem;
            margin-top: 1rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background-color: var(--secondary);
            border-radius: var(--radius);
            margin-bottom: 0.75rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
        }
        
        .user-details {
            flex: 1;
            overflow: hidden;
        }
        
        .user-details .user-name {
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-details .user-email {
            font-size: 0.75rem;
            color: var(--secondary-foreground);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            color: var(--secondary-foreground);
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }

        .nav-link:hover {
            background-color: var(--secondary);
        }

        .nav-link.active {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }

        .nav-link i {
            width: 20px;
            height: 20px;
        }

        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .page-header p {
            color: var(--secondary-foreground);
            font-size: 1rem;
        }

        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--input);
            border-radius: var(--radius);
            font-family: var(--font-sans);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 82, 204, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }

        .btn-primary:hover {
            background-color: #0045a6;
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: #d3d9df;
        }

        .btn-danger {
            background-color: var(--danger);
            color: var(--primary-foreground);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }

        #products-container .product-item {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        #products-container .product-item:last-child {
            border-bottom: none;
        }

        .totals-summary {
            margin-top: 2rem;
            display: flex;
            justify-content: flex-end;
        }

        .totals-table {
            width: 100%;
            max-width: 350px;
        }

        .totals-table tr td {
            padding: 0.75rem;
        }

        .totals-table tr td:last-child {
            text-align: right;
            font-weight: 600;
        }

        .totals-table tr.grand-total td {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            border-top: 2px solid var(--border);
        }

        .template-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .template-card {
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .template-card:hover {
            border-color: var(--primary);
        }

        .template-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.3);
        }

        .template-card img {
            width: 100%;
            height: auto;
            border-radius: calc(var(--radius) - 4px);
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }

        .template-card span {
            font-weight: 600;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--foreground);
            color: var(--background);
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.success { background-color: var(--success); color: white; }
        .toast.error { background-color: var(--danger); color: white; }
        
        .input-with-button {
            display: flex;
            gap: 0.5rem;
        }
        
        .input-with-button input {
            flex: 1;
        }
        
        .btn-icon {
            padding: 0.75rem;
            min-width: auto;
        }
        
        /* Animations */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <i data-lucide="receipt"></i>
            <h1>ChatBill</h1>
        </div>
        <nav class="sidebar-nav">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#dashboard" class="nav-link active">
                        <i data-lucide="layout-dashboard"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#invoice-generator" class="nav-link">
                        <i data-lucide="file-plus-2"></i>
                        <span>GenereazƒÉ FacturƒÉ</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#proforma-generator" class="nav-link">
                        <i data-lucide="file-text"></i>
                        <span>GenereazƒÉ ProformƒÉ</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#invoices" class="nav-link">
                        <i data-lucide="history"></i>
                        <span>Istoric Facturi</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#proformas" class="nav-link">
                        <i data-lucide="file-stack"></i>
                        <span>Istoric Proforme</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#chat" class="nav-link">
                        <i data-lucide="message-circle"></i>
                        <span>Chat GPT</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#settings" class="nav-link">
                        <i data-lucide="settings"></i>
                        <span>SetƒÉri</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Utilizator</div>
                    <div class="user-email" id="userEmail">user@example.com</div>
                </div>
            </div>
            <button id="logout-btn" class="btn btn-secondary" style="width: 100%;">
                <i data-lucide="log-out"></i>
                Deconectare
            </button>
        </div>
    </aside>

    <main class="main-content">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <div class="page-header">
                <h2>Dashboard</h2>
                <p>Bun venit! Aici ave»õi o privire de ansamblu asupra activitƒÉ»õii dvs.</p>
            </div>
            <div class="card">
                <h3>√én cur√¢nd...</h3>
                <p>AceastƒÉ sec»õiune va con»õine statistici »ôi informa»õii utile.</p>
            </div>
        </div>

        <!-- Invoice Generator Page -->
        <div id="invoice-generator" class="page">
            <div class="page-header">
                <h2>GenereazƒÉ o NouƒÉ FacturƒÉ</h2>
                <p>Completa»õi detaliile de mai jos pentru a emite o nouƒÉ facturƒÉ.</p>
            </div>
            <form id="invoice-form">
                <div class="card">
                    <h3>Detalii Client</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="client-type">Tip Client</label>
                            <select id="client-type" name="client-type">
                                <option value="company">PersoanƒÉ JuridicƒÉ</option>
                                <option value="individual">PersoanƒÉ FizicƒÉ</option>
                            </select>
                        </div>
                        <div class="form-group" id="company-fields">
                            <label for="client-name">Nume Companie</label>
                            <input type="text" id="client-name" name="client-name" required>
                            <label for="client-cui">CUI</label>
                            <div class="input-with-button">
                                <input type="text" id="client-cui" name="client-cui" required placeholder="ex: RO12345678">
                                <button type="button" id="autocomplete-client-btn" class="btn btn-secondary btn-icon" title="Auto-completare date din ANAF">
                                    <i data-lucide="sparkles"></i>
                                </button>
                            </div>
                            <label for="client-regCom">Reg. Com.</label>
                            <input type="text" id="client-regCom" name="client-regCom">
                        </div>
                         <div class="form-group" id="individual-fields" style="display: none;">
                            <label for="client-firstName">Prenume</label>
                            <input type="text" id="client-firstName" name="client-firstName">
                            <label for="client-lastName">Nume</label>
                            <input type="text" id="client-lastName" name="client-lastName">
                             <label for="client-cnp">CNP</label>
                            <input type="text" id="client-cnp" name="client-cnp">
                        </div>
                        <div class="form-group">
                            <label for="client-address">AdresƒÉ</label>
                            <input type="text" id="client-address" name="client-address">
                        </div>
                        <div class="form-group">
                            <label for="client-city">Ora»ô</label>
                            <input type="text" id="client-city" name="client-city">
                        </div>
                        <div class="form-group">
                            <label for="client-county">Jude»õ</label>
                            <input type="text" id="client-county" name="client-county">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Produse / Servicii</h3>
                    <div id="products-container">
                        <!-- Produsele vor fi adƒÉugate aici de JS -->
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 1.5rem;">
                        <button type="button" id="add-product" class="btn btn-secondary">
                            <i data-lucide="plus"></i>
                            AdaugƒÉ Produs
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="totals-summary">
                        <table class="totals-table">
                            <tbody>
                                <tr>
                                    <td>Subtotal:</td>
                                    <td id="summary-subtotal">0.00 RON</td>
                                </tr>
                                <tr>
                                    <td>TVA:</td>
                                    <td id="summary-vat">0.00 RON</td>
                                </tr>
                                <tr class="grand-total">
                                    <td>Total General:</td>
                                    <td id="summary-total">0.00 RON</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="text-align: right;">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save"></i>
                        GenereazƒÉ »ôi SalveazƒÉ Factura
                    </button>
                </div>
            </form>
        </div>

        <!-- Invoices History Page -->
        <div id="invoices" class="page">
            <div class="page-header">
                <h2>Istoric Facturi</h2>
                <p>Vizualiza»õi »ôi gestiona»õi facturile emise anterior.</p>
            </div>
            <div class="card">
                <div id="invoices-loading" style="text-align: center; padding: 2rem;">
                    <div class="animate-spin" style="width: 48px; height: 48px; margin: 0 auto 1rem;">
                        <i data-lucide="loader" style="width: 48px; height: 48px;"></i>
                    </div>
                    <p>Se √ÆncarcƒÉ facturile...</p>
                </div>
                <div id="invoices-list" style="display: none;">
                    <!-- Facturile vor fi afi»ôate aici -->
                </div>
                <div id="invoices-empty" style="display: none; text-align: center; padding: 2rem; color: var(--secondary-foreground);">
                    <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem;"></i>
                    <p>Nu ave»õi facturi generate √ÆncƒÉ.</p>
                </div>
            </div>
        </div>

        <!-- Chat GPT Page -->
        <div id="chat" class="page">
            <div class="page-header">
                <h2>Chat GPT Asistent</h2>
                <p>Discuta»õi cu asistentul AI pentru ajutor »ôi recomandƒÉri.</p>
            </div>
            <div class="card" style="height: 600px; display: flex; flex-direction: column;">
                <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem; background: var(--background);">
                    <div style="text-align: center; color: var(--secondary-foreground); padding: 2rem;">
                        <i data-lucide="message-circle" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i>
                        <p>Bun venit! Cum vƒÉ pot ajuta astƒÉzi?</p>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="chat-input" placeholder="Scrie»õi mesajul dvs. aici..." style="flex: 1; padding: 0.75rem; border: 1px solid var(--input); border-radius: var(--radius);">
                    <button type="button" id="chat-send-btn" class="btn btn-primary">
                        <i data-lucide="send"></i>
                        Trimite
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <div class="page-header">
                <h2>SetƒÉri Companie »ôi Preferin»õe</h2>
                <p>Configura»õi datele companiei dvs. »ôi alte preferin»õe.</p>
            </div>
            <form id="settings-form">
                <div class="card">
                    <h3>Date Companie EmitentƒÉ</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="company-name">Nume Companie</label>
                            <input type="text" id="company-name" name="name">
                        </div>
                        <div class="form-group">
                            <label for="company-cui">CUI</label>
                            <div class="input-with-button">
                                <input type="text" id="company-cui" name="cui" placeholder="ex: RO12345678">
                                <button type="button" id="autocomplete-company-btn" class="btn btn-secondary btn-icon" title="Auto-completare date din ANAF">
                                    <i data-lucide="sparkles"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="company-regCom">Reg. Com.</label>
                            <input type="text" id="company-regCom" name="regCom">
                        </div>
                        <div class="form-group">
                            <label for="company-address">AdresƒÉ Sediu Social</label>
                            <input type="text" id="company-address" name="address">
                        </div>
                        <div class="form-group">
                            <label for="company-city">Ora»ô</label>
                            <input type="text" id="company-city" name="city">
                        </div>
                        <div class="form-group">
                            <label for="company-county">Jude»õ</label>
                            <input type="text" id="company-county" name="county">
                        </div>
                        <div class="form-group">
                            <label for="company-iban">IBAN</label>
                            <input type="text" id="company-iban" name="iban">
                        </div>
                        <div class="form-group">
                            <label for="company-bank">BancƒÉ</label>
                            <input type="text" id="company-bank" name="bank">
                        </div>
                         <div class="form-group">
                            <label for="company-capital">Capital Social</label>
                            <input type="text" id="company-capital" name="capital">
                        </div>
                        <div class="form-group">
                            <label for="company-phone">Telefon</label>
                            <input type="text" id="company-phone" name="phone">
                        </div>
                        <div class="form-group">
                            <label for="company-email">Email</label>
                            <input type="email" id="company-email" name="email">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>Integrare ANAF e-Factura</h3>
                    <p>Conecta»õi contul ANAF pentru trimiterea automatƒÉ a facturilor √Æn sistemul e-Factura.</p>
                    <div id="anaf-status-container" style="margin-top: 1rem;">
                        <div id="anaf-disconnected" style="display: none;">
                            <div style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: var(--radius); margin-bottom: 1rem;">
                                <p style="margin: 0; color: #856404;"><strong>‚ö†Ô∏è Nu sunte»õi conectat la ANAF</strong></p>
                                <p style="margin: 0.5rem 0 0 0; color: #856404; font-size: 0.9rem;">Pentru a trimite facturi √Æn e-Factura, conecta»õi-vƒÉ cu contul ANAF.</p>
                            </div>
                            <button type="button" id="anaf-connect-btn" class="btn btn-primary">
                                <i data-lucide="link"></i>
                                ConecteazƒÉ ANAF e-Factura
                            </button>
                        </div>
                        <div id="anaf-connected" style="display: none;">
                            <div style="padding: 1rem; background: #d4edda; border: 1px solid #28a745; border-radius: var(--radius); margin-bottom: 1rem;">
                                <p style="margin: 0; color: #155724;"><strong>‚úÖ Conectat la ANAF e-Factura</strong></p>
                                <p style="margin: 0.5rem 0 0 0; color: #155724; font-size: 0.9rem;">
                                    CUI: <strong id="anaf-cui">-</strong> | Companie: <strong id="anaf-company">-</strong>
                                </p>
                                <p style="margin: 0.5rem 0 0 0; color: #155724; font-size: 0.85rem;">
                                    Ultima actualizare: <span id="anaf-last-refresh">-</span>
                                </p>
                            </div>
                            <button type="button" id="anaf-disconnect-btn" class="btn btn-secondary">
                                <i data-lucide="unlink"></i>
                                DeconecteazƒÉ ANAF
                            </button>
                        </div>
                        <div id="anaf-loading" style="display: block;">
                            <p style="color: var(--secondary-foreground);">
                                <i data-lucide="loader-2" class="animate-spin"></i>
                                Verificare status conexiune...
                            </p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>Template Preferat FacturƒÉ</h3>
                    <p>Selecta»õi stilul vizual implicit pentru facturile generate.</p>
                    <br>
                    <div id="template-selector-settings" class="template-selector">
                        <div class="template-card active" data-template="modern">
                            <img src="https://i.imgur.com/6ZIZg8t.png" alt="Modern Template">
                            <span>Modern</span>
                            <small style="display: block; margin-top: 0.25rem; color: var(--secondary-foreground);">Gradient albastru, profesional</small>
                        </div>
                        <div class="template-card" data-template="professional">
                            <img src="https://i.imgur.com/L3gV1S2.png" alt="Professional Template">
                            <span>Professional</span>
                            <small style="display: block; margin-top: 0.25rem; color: var(--secondary-foreground);">Elegant, minimalist</small>
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save"></i>
                        SalveazƒÉ SetƒÉrile
                    </button>
                </div>
            </form>
        </div>
    </main>
    
    <div id="toast-container"></div>

    <script src="/js/app.js"></script>
    <script>
        lucide.createIcons();

        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');

            // Navigation
            function navigateTo(hash) {
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.hash === hash);
                });
                pages.forEach(page => {
                    page.classList.toggle('active', '#' + page.id === hash);
                });
                
                // √éncarcƒÉ facturile c√¢nd utilizatorul navigheazƒÉ la pagina de istoric
                if (hash === '#invoices') {
                    loadInvoices();
                }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.hash;
                    navigateTo(targetId);
                    window.location.hash = targetId;
                });
            });

            // Initial page load
            const currentHash = window.location.hash || '#dashboard';
            navigateTo(currentHash);

            // Client type toggle
            const clientTypeSelect = document.getElementById('client-type');
            const companyFields = document.getElementById('company-fields');
            const individualFields = document.getElementById('individual-fields');

            clientTypeSelect.addEventListener('change', () => {
                if (clientTypeSelect.value === 'company') {
                    companyFields.style.display = 'block';
                    individualFields.style.display = 'none';
                } else {
                    companyFields.style.display = 'none';
                    individualFields.style.display = 'block';
                }
            });
            
            // Initialize template selector in settings
            initTemplateSelector();
            
            // Add first product on page load
            addProduct();
        });
        
        function initTemplateSelector() {
            const selector = document.getElementById('template-selector-settings');
            if (!selector) return;
            
            const cards = selector.querySelectorAll('.template-card');
            
            cards.forEach(card => {
                card.addEventListener('click', () => {
                    cards.forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                });
            });
        }
        
        // Products Management
        let productCount = 0;
        const productsContainer = document.getElementById('products-container');
        
        function addProduct() {
            productCount++;
            const productItem = document.createElement('div');
            productItem.classList.add('product-item');
            productItem.innerHTML = `
                <div class="form-group">
                    <label>Descriere Produs/Serviciu</label>
                    <input type="text" name="product-name-${productCount}" placeholder="ex: Servicii consultan»õƒÉ" required>
                </div>
                <div class="form-group">
                    <label>Cant.</label>
                    <input type="number" name="product-quantity-${productCount}" value="1" min="0" step="any" class="recalculate">
                </div>
                <div class="form-group">
                    <label>U.M.</label>
                    <input type="text" name="product-unit-${productCount}" value="buc">
                </div>
                <div class="form-group">
                    <label>Pre»õ Unitar</label>
                    <input type="number" name="product-price-${productCount}" value="0" min="0" step="any" class="recalculate">
                </div>
                <div class="form-group">
                    <label>TVA (%)</label>
                    <input type="number" name="product-vat-${productCount}" value="19" min="0" class="recalculate">
                </div>
                <button type="button" class="btn btn-danger remove-product" style="margin-top: 1.5rem;">
                    <i data-lucide="trash-2"></i>
                </button>
            `;
            productsContainer.appendChild(productItem);
            lucide.createIcons(); // Re-render icons
            
            productItem.querySelector('.remove-product').addEventListener('click', () => {
                productItem.remove();
                calculateTotals();
            });
            
            productItem.querySelectorAll('.recalculate').forEach(input => {
                input.addEventListener('input', calculateTotals);
            });
        }

        document.getElementById('add-product').addEventListener('click', addProduct);

        function calculateTotals() {
            let subtotal = 0;
            let vat = 0;

            productsContainer.querySelectorAll('.product-item').forEach(item => {
                const quantity = parseFloat(item.querySelector('input[name^="product-quantity"]').value) || 0;
                const price = parseFloat(item.querySelector('input[name^="product-price"]').value) || 0;
                const vatRate = parseFloat(item.querySelector('input[name^="product-vat"]').value) || 0;

                const itemSubtotal = quantity * price;
                const itemVat = itemSubtotal * (vatRate / 100);

                subtotal += itemSubtotal;
                vat += itemVat;
            });

            const total = subtotal + vat;

            document.getElementById('summary-subtotal').textContent = `${subtotal.toFixed(2)} RON`;
            document.getElementById('summary-vat').textContent = `${vat.toFixed(2)} RON`;
            document.getElementById('summary-total').textContent = `${total.toFixed(2)} RON`;
        }
        
        // Toast notifications
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
        
        // Form Submissions
        
        // Settings Form
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const settingsData = Object.fromEntries(formData.entries());
            
            const selectedTemplate = document.querySelector('#template-selector-settings .template-card.active');
            if (selectedTemplate) {
                settingsData.preferredTemplate = selectedTemplate.dataset.template;
            }

            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settingsData)
                });
                const result = await response.json();
                if (result.success) {
                    showToast('SetƒÉrile au fost salvate cu succes!');
                } else {
                    throw new Error(result.error || 'A apƒÉrut o eroare la salvarea setƒÉrilor.');
                }
            } catch (error) {
                showToast(error.message, 'error');
            }
        });
        
        // Invoice Form
        document.getElementById('invoice-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const clientType = document.getElementById('client-type').value;
            let clientData = {};
            if (clientType === 'company') {
                clientData = {
                    type: 'company',
                    name: document.getElementById('client-name').value,
                    cui: document.getElementById('client-cui').value,
                    regCom: document.getElementById('client-regCom').value,
                    address: document.getElementById('client-address').value,
                    city: document.getElementById('client-city').value,
                    county: document.getElementById('client-county').value,
                };
            } else {
                 clientData = {
                    type: 'individual',
                    firstName: document.getElementById('client-firstName').value,
                    lastName: document.getElementById('client-lastName').value,
                    cnp: document.getElementById('client-cnp').value,
                    address: document.getElementById('client-address').value,
                    city: document.getElementById('client-city').value,
                    county: document.getElementById('client-county').value,
                };
            }
            
            const products = [];
            productsContainer.querySelectorAll('.product-item').forEach((item, index) => {
                const i = index + 1;
                products.push({
                    name: item.querySelector(`input[name="product-name-${i}"]`).value,
                    quantity: parseFloat(item.querySelector(`input[name="product-quantity-${i}"]`).value),
                    unit: item.querySelector(`input[name="product-unit-${i}"]`).value,
                    price: parseFloat(item.querySelector(`input[name="product-price-${i}"]`).value),
                    vat: parseInt(item.querySelector(`input[name="product-vat-${i}"]`).value)
                });
            });

            const invoicePayload = {
                client: clientData,
                products: products
            };
            
            console.log('üì§ Trimit factura:', invoicePayload);

            try {
                const response = await fetch('/api/invoices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(invoicePayload)
                });
                
                console.log('üì• Response status:', response.status);
                const result = await response.json();
                console.log('üì¶ Response data:', result);
                
                if (result.success && result.invoice.pdfPath) {
                    showToast('Factura a fost generatƒÉ cu succes!');
                    console.log('üîó Deschid PDF:', result.invoice.pdfPath);
                    window.open(result.invoice.pdfPath, '_blank');
                    e.target.reset();
                    productsContainer.innerHTML = '';
                    addProduct();
                    calculateTotals();
                } else {
                    throw new Error(result.error || 'A apƒÉrut o eroare la generarea facturii.');
                }
            } catch (error) {
                console.error('‚ùå Eroare generare:', error);
                showToast(error.message, 'error');
            }
        });
        
        // Load settings on page load
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const result = await response.json();
                if (result.success && result.settings) {
                    const form = document.getElementById('settings-form');
                    for (const key in result.settings) {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input) {
                            input.value = result.settings[key] || '';
                        }
                    }
                    
                    const preferredTemplate = result.settings.preferredTemplate;
                    if (preferredTemplate) {
                        const card = document.querySelector(`#template-selector-settings .template-card[data-template="${preferredTemplate}"]`);
                        if (card) {
                            card.click();
                        }
                    }
                }
            } catch (error) {
                console.error('Eroare la √ÆncƒÉrcarea setƒÉrilor:', error);
            }
        }

        loadSettings();
        
        // ANAF Status Check
        async function checkAnafStatus() {
            try {
                const response = await fetch('/api/anaf/status');
                const result = await response.json();
                
                document.getElementById('anaf-loading').style.display = 'none';
                
                if (result.success && result.connected) {
                    document.getElementById('anaf-connected').style.display = 'block';
                    document.getElementById('anaf-disconnected').style.display = 'none';
                    
                    document.getElementById('anaf-cui').textContent = result.anafAuth.cui || '-';
                    document.getElementById('anaf-company').textContent = result.anafAuth.companyName || '-';
                    document.getElementById('anaf-last-refresh').textContent = 
                        new Date(result.anafAuth.lastRefresh).toLocaleString('ro-RO');
                } else {
                    document.getElementById('anaf-connected').style.display = 'none';
                    document.getElementById('anaf-disconnected').style.display = 'block';
                }
                
                lucide.createIcons();
            } catch (error) {
                console.error('Eroare verificare status ANAF:', error);
                document.getElementById('anaf-loading').style.display = 'none';
                document.getElementById('anaf-disconnected').style.display = 'block';
                lucide.createIcons();
            }
        }
        
        checkAnafStatus();
        
        // ANAF Connect
        document.getElementById('anaf-connect-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/anaf/connect');
                const result = await response.json();
                
                if (result.success && result.authUrl) {
                    showToast('Redirectare cƒÉtre ANAF pentru autentificare...');
                    window.location.href = result.authUrl;
                } else {
                    throw new Error(result.error || 'Eroare la conectarea ANAF');
                }
            } catch (error) {
                showToast(error.message, 'error');
            }
        });
        
        // ANAF Disconnect
        document.getElementById('anaf-disconnect-btn').addEventListener('click', async () => {
            if (!confirm('Sigur dori»õi sƒÉ deconecta»õi contul ANAF?')) return;
            
            try {
                const response = await fetch('/api/anaf/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast('Contul ANAF a fost deconectat cu succes!');
                    checkAnafStatus();
                } else {
                    throw new Error(result.error || 'Eroare la deconectarea ANAF');
                }
            } catch (error) {
                showToast(error.message, 'error');
            }
        });
        
        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/auth/me');
                const result = await response.json();
                
                if (result.success && result.user) {
                    const user = result.user;
                    document.getElementById('userName').textContent = user.name || 'Utilizator';
                    document.getElementById('userEmail').textContent = user.email || '';
                    
                    // Set avatar initials
                    const initials = (user.name || 'U').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    document.getElementById('userAvatar').textContent = initials;
                }
            } catch (error) {
                console.error('Eroare la √ÆncƒÉrcarea informa»õiilor utilizator:', error);
            }
        }
        
        loadUserInfo();
        
        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm('Sigur dori»õi sƒÉ vƒÉ deconecta»õi?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            }
        });

        // Auto-complete functionality for company settings
        document.getElementById('autocomplete-company-btn').addEventListener('click', async () => {
            const cuiInput = document.getElementById('company-cui');
            const cui = cuiInput.value.trim();
            
            console.log('üîç Autocomplete CUI company clicked:', cui);
            
            if (!cui) {
                showToast('Introduce»õi un CUI valid', 'error');
                return;
            }
            
            const btn = document.getElementById('autocomplete-company-btn');
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i>';
            lucide.createIcons();
            
            try {
                const url = `/api/settings/autocomplete/${encodeURIComponent(cui)}`;
                console.log('üì° Fetch URL:', url);
                
                const response = await fetch(url);
                console.log('üì• Response status:', response.status);
                
                const result = await response.json();
                console.log('üì¶ Response data:', result);
                
                if (result.success && result.settings) {
                    const data = result.settings;
                    if (data.name) document.getElementById('company-name').value = data.name;
                    if (data.address) document.getElementById('company-address').value = data.address;
                    if (data.city) document.getElementById('company-city').value = data.city;
                    if (data.county) document.getElementById('company-county').value = data.county;
                    if (data.postalCode) document.getElementById('company-postal').value = data.postalCode;
                    if (data.regCom) document.getElementById('company-regCom').value = data.regCom;
                    if (data.phone) document.getElementById('company-phone').value = data.phone;
                    
                    showToast('Date completate automat cu succes!', 'success');
                } else {
                    throw new Error(result.error || 'Nu s-au gƒÉsit date pentru acest CUI');
                }
            } catch (error) {
                console.error('‚ùå Error autocomplete:', error);
                showToast(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="sparkles"></i>';
                lucide.createIcons();
            }
        });
        
        // Auto-complete functionality for client in invoice
        document.getElementById('autocomplete-client-btn').addEventListener('click', async () => {
            const cuiInput = document.getElementById('client-cui');
            const cui = cuiInput.value.trim();
            
            console.log('üîç Autocomplete CUI client clicked:', cui);
            
            if (!cui) {
                showToast('Introduce»õi un CUI valid pentru client', 'error');
                return;
            }
            
            const btn = document.getElementById('autocomplete-client-btn');
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i>';
            lucide.createIcons();
            
            try {
                const url = `/api/settings/autocomplete/${encodeURIComponent(cui)}`;
                console.log('üì° Fetch URL:', url);
                
                const response = await fetch(url);
                console.log('üì• Response status:', response.status);
                
                const result = await response.json();
                console.log('üì¶ Response data:', result);
                
                if (result.success && result.settings) {
                    const data = result.settings;
                    if (data.name) document.getElementById('client-name').value = data.name;
                    if (data.address) document.getElementById('client-address').value = data.address;
                    if (data.city) document.getElementById('client-city').value = data.city;
                    if (data.county) document.getElementById('client-county').value = data.county;
                    if (data.regCom) document.getElementById('client-regCom').value = data.regCom;
                    
                    showToast('Date client completate automat!', 'success');
                } else {
                    throw new Error(result.error || 'Nu s-au gƒÉsit date pentru acest CUI');
                }
            } catch (error) {
                console.error('‚ùå Error autocomplete:', error);
                showToast(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="sparkles"></i>';
                lucide.createIcons();
            }
        });

        // Load invoices functionality
        async function loadInvoices() {
            const loadingEl = document.getElementById('invoices-loading');
            const listEl = document.getElementById('invoices-list');
            const emptyEl = document.getElementById('invoices-empty');
            
            loadingEl.style.display = 'block';
            listEl.style.display = 'none';
            emptyEl.style.display = 'none';
            
            try {
                const response = await fetch('/api/invoices');
                const result = await response.json();
                
                if (result.success && result.invoices && result.invoices.length > 0) {
                    listEl.innerHTML = '';
                    
                    result.invoices.forEach(invoice => {
                        const invoiceCard = document.createElement('div');
                        invoiceCard.style.cssText = `
                            padding: 1rem;
                            border: 1px solid var(--border);
                            border-radius: var(--radius);
                            margin-bottom: 1rem;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        `;
                        
                        const infoDiv = document.createElement('div');
                        infoDiv.innerHTML = `
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Factura #${invoice.invoiceNumber}</div>
                            <div style="color: var(--secondary-foreground); font-size: 0.875rem;">
                                ${invoice.clientName || 'Client necunoscut'} ‚Ä¢ 
                                ${new Date(invoice.createdAt).toLocaleDateString('ro-RO')} ‚Ä¢ 
                                ${invoice.total.toFixed(2)} RON
                            </div>
                        `;
                        
                        const actionsDiv = document.createElement('div');
                        actionsDiv.style.display = 'flex';
                        actionsDiv.style.gap = '0.5rem';
                        
                        const downloadBtn = document.createElement('a');
                        downloadBtn.href = invoice.pdfPath;
                        downloadBtn.target = '_blank';
                        downloadBtn.className = 'btn';
                        downloadBtn.innerHTML = '<i data-lucide="download"></i> DescarcƒÉ';
                        
                        actionsDiv.appendChild(downloadBtn);
                        invoiceCard.appendChild(infoDiv);
                        invoiceCard.appendChild(actionsDiv);
                        listEl.appendChild(invoiceCard);
                    });
                    
                    lucide.createIcons();
                    loadingEl.style.display = 'none';
                    listEl.style.display = 'block';
                } else {
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                }
            } catch (error) {
                console.error('‚ùå Eroare √ÆncƒÉrcare facturi:', error);
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
        }

        // Chat GPT functionality
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        
        // PƒÉstreazƒÉ istoricul conversa»õiei
        let chatHistory = [];
        
        function addChatMessage(message, isUser = false, pdfPath = null) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                margin-bottom: 1rem;
                padding: 1rem;
                border-radius: var(--radius);
                background: ${isUser ? 'var(--primary)' : 'white'};
                color: ${isUser ? 'white' : 'var(--foreground)'};
                max-width: 80%;
                margin-left: ${isUser ? 'auto' : '0'};
                margin-right: ${isUser ? '0' : 'auto'};
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            
            // AdaugƒÉ textul mesajului
            const textDiv = document.createElement('div');
            textDiv.textContent = message;
            messageDiv.appendChild(textDiv);
            
            // DacƒÉ existƒÉ PDF, adaugƒÉ buton de descƒÉrcare
            if (pdfPath && !isUser) {
                const downloadBtn = document.createElement('a');
                downloadBtn.href = pdfPath;
                downloadBtn.target = '_blank';
                downloadBtn.style.cssText = `
                    display: inline-flex;
                    align-items: center;
                    gap: 0.5rem;
                    margin-top: 0.5rem;
                    padding: 0.5rem 1rem;
                    background: var(--primary);
                    color: white;
                    border-radius: var(--radius);
                    text-decoration: none;
                    font-size: 0.875rem;
                `;
                downloadBtn.innerHTML = '<i data-lucide="download" style="width: 16px; height: 16px;"></i> DescarcƒÉ PDF';
                messageDiv.appendChild(downloadBtn);
                lucide.createIcons();
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // AdaugƒÉ √Æn istoric
            chatHistory.push({ role: isUser ? 'user' : 'assistant', content: message });
        }
        
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            addChatMessage(message, true);
            chatInput.value = '';
            chatSendBtn.disabled = true;
            
            try {
                const response = await fetch('/api/gpt-chat/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message,
                        conversationHistory: chatHistory 
                    })
                });
                const result = await response.json();
                
                if (result.success && result.message) {
                    // Afi»ôeazƒÉ mesajul cu link PDF dacƒÉ existƒÉ
                    addChatMessage(result.message, false, result.pdfPath);
                    
                    // DacƒÉ s-a generat o facturƒÉ, re√ÆmprospƒÉteazƒÉ istoricul
                    if (result.invoice && window.location.hash === '#invoices') {
                        loadInvoices();
                    }
                } else {
                    throw new Error(result.error || 'Eroare la trimiterea mesajului');
                }
            } catch (error) {
                addChatMessage('Ne pare rƒÉu, a apƒÉrut o eroare. VƒÉ rugƒÉm sƒÉ √Æncerca»õi din nou.', false);
                console.error('‚ùå Chat error:', error);
            } finally {
                chatSendBtn.disabled = false;
            }
        }
        
        chatSendBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

    </script>
</body>
</html>
